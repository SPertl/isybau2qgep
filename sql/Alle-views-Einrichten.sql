/* 
Geometriebildung aus ISYBAU Daten.
EPSG:25832 ETRS89/UTM zone 32N
*/

-- Erstellung der Views in separaten Schema zum Schutz bei Import -overwrite
--CREATE SCHEMA qgisybau;

-- KNOTEN: Bildung der Punktgeometrien, Achtung: nicht deckungsgleich mit "Abwassertechnische Anlagen", mehrere Punkte pro Anlage (SMP, DMP, etc.) möglich!

-------------------------------------------------------------------
-- PUNKT-GEOMETRIEN -----------------
-------------------------------------------------------------------

CREATE OR REPLACE VIEW qgisybau.v_punktgeometrien AS 
 SELECT kp.ogc_fid,
    kp.ogr_pkid,
    kp.parent_ogr_pkid,
    kp.rechtswert,
    kp.hochwert,
    kp.punkthoehe,
    kp.punktattributabwasser,
    kp.lagegenauigkeitsstufe,
    kp.hoehengenauigkeitsstufe,
    st_setsrid(st_makepoint(kp.rechtswert, kp.hochwert), 25832)::geometry(Point,25832) AS p_geom_2d
   FROM isybau.identi_datenk_stammd_abwassanlage_geomet_geomet_knoten_punkt kp;



-------------------------------------------------------------------
-- KANTEN-GEOMETRIEN -----------------
-------------------------------------------------------------------

CREATE OR REPLACE VIEW qgisybau.v_liniengeometrien AS

   SELECT 
      kk.parent_ogr_pkid,
      st_setsrid(st_makeline(st_makepoint(kk.start_rechtswert, kk.start_hochwert), 
                             st_makepoint(kk.ende_rechtswert, kk.ende_hochwert)), 25832)::geometry(LineString, 25832) AS l_geom_2d
   FROM 
      isybau.identi_datenk_stammd_abwassanlage_geomet_geomet_kanten_kante kk

   UNION ALL

   SELECT 
      pp.parent_ogr_pkid,
      st_setsrid(ST_UNION(st_makeline(st_makepoint(pk.start_rechtswert, pk.start_hochwert), 
                                      st_makepoint(pk.ende_rechtswert, pk.ende_hochwert))), 25832)::geometry(MultiLineString, 25832) AS l_geom_2d
   FROM 
      isybau.ident_daten_stamm_abwasanlag_geome_geome_polygo_polygo_kante pk
   LEFT JOIN 
      isybau.ident_daten_stammd_abwassanlage_geomet_geomet_polygo_polygon pp
      ON pk.parent_ogr_pkid::TEXT = pp.ogr_pkid::TEXT
   GROUP BY 
      pp.parent_ogr_pkid;



-------------------------------------------------------------------
-- FLÄCHEN-GEOMETRIEN -----------------
-------------------------------------------------------------------

-- KNOTEN: Bildung von Flächengeometrien
CREATE OR REPLACE VIEW qgisybau.v_flaechengeometrien AS 
 SELECT ( SELECT p_1.parent_ogr_pkid
           FROM isybau.ident_daten_stammd_abwassanlage_geomet_geomet_polygo_polygon p_1
          WHERE pk.parent_ogr_pkid::text = p_1.ogr_pkid::text) AS parent_ogr_pkid,
    st_setsrid(st_makepolygon(st_makeline(st_makeline(st_makepoint(pk.start_rechtswert, pk.start_hochwert), 
                                                      st_makepoint(pk.ende_rechtswert, pk.ende_hochwert)))), 25832)::geometry(Polygon,25832) AS f_geom_2d
   FROM isybau.ident_daten_stamm_abwasanlag_geome_geome_polygo_polygo_kante pk,
    isybau.ident_daten_stammd_abwassanlage_geomet_geomet_polygo_polygon p
  WHERE pk.parent_ogr_pkid::text = p.ogr_pkid::text 
    AND (p.polygonart = ANY (ARRAY[1, 2])) -- V105: 1=innerer Polygonring eines Objektes (geschlossen), 2=äußerer Polyring eines Objektes (geschlossen)
  GROUP BY pk.parent_ogr_pkid;
  
  
  
  /*
KNOTEN
Abwassertechnische Anlagen gem. Arbeitshilfen Abwasser 
(http://www.arbeitshilfen-abwasser.de/html/ISYBAU_Austauschformate_Abwasser.14.08.html)
Schächte (S), Anschlusspunkte (AP) und Bauwerke (BW)
*/

-- Erstellung der Views in separatem Schema zum Schutz bei GMLAS Import -overwrite
--CREATE SCHEMA isybau;

-- S punktförmige Schächte repräsentiert durch den Schachtmittelpunkt 
CREATE OR REPLACE VIEW qgisybau.v_knoten_schacht_smp AS 
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_schacht_schachtfunktion, a.knoten_schacht_schachttiefe, a.knoten_schacht_einstieghilfe, a.knoten_schacht_arteinstieghilfe, a.knoten_schacht_materialsteighilfen, a.knoten_schacht_innenschutz, a.knoten_schacht_anzahlanschluesse, a.knoten_schacht_uebergabeschacht, a.knoten_schacht_anzahldeckel, a.knoten_schacht_abdeckung_deckelform, a.knoten_schacht_abdeckung_deckeltyp, a.knoten_schacht_abdeckung_laengedeckel, a.knoten_schacht_abdeckung_breitedeckel, a.knoten_schacht_abdeckung_abdeckungsklasse, a.knoten_schacht_abdeckung_materialabdeckung, a.knoten_schacht_abdeckung_anzahlauflageringe, a.knoten_schacht_abdeckung_hoeheauflageringe, a.knoten_schacht_abdeckung_schmutzfaenger, a.knoten_schacht_aufbau_aufbauform, a.knoten_schacht_aufbau_abdeckplatte, a.knoten_schacht_aufbau_konus, a.knoten_schacht_aufbau_laengeaufbau, a.knoten_schacht_aufbau_breiteaufbau, a.knoten_schacht_aufbau_hoeheaufbau, a.knoten_schacht_aufbau_materialaufbau, a.knoten_schacht_untereschachtzone_untereschachtzoneform, a.knoten_schacht_untereschachtzone_uebergangsplatte, a.knoten_schacht_untereschachtzone_konus, a.knoten_schacht_untereschachtzone_laengeunten, a.knoten_schacht_untereschachtzone_breiteunten, a.knoten_schacht_untereschachtzone_hoeheunten, a.knoten_schacht_untereschachtzone_materialunten, a.knoten_schacht_untereschachtzone_podest, a.knoten_schacht_unterteil_unterteilform, a.knoten_schacht_unterteil_laengeunterteil, a.knoten_schacht_unterteil_breiteunterteil, a.knoten_schacht_unterteil_hoeheunterteil, a.knoten_schacht_unterteil_materialunterteil, a.knoten_schacht_unterteil_gerinneform, a.knoten_schacht_unterteil_materialgerinne, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 -- G100 2=Knoten
    AND a.knoten_knotentyp = 0 -- G300 0=Schacht
    AND a.geometrie_geoobjekttyp::text = 'P'::text -- V200 P=Punktobjekt
    AND p.punktattributabwasser::text = 'SMP'::text; -- V106: PunktattributAbwasser=SMP

COMMENT ON view qgisybau.v_knoten_schacht_smp IS 'punktförmige Schächte repräsentiert durch den Schachtmittelpunkt';

CREATE OR REPLACE RULE "Edit-Data" AS
    ON UPDATE TO qgisybau.v_knoten_schacht_smp
    DO INSTEAD 
    
    UPDATE isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage SET
        objektbezeichnung = NEW.objektbezeichnung, objektart = NEW.objektart, alteobjektbezeichnung = NEW.alteobjektbezeichnung, lisa_guid = NEW.lisa_guid, reihenfolgeid = NEW.reihenfolgeid, status = NEW.status, baujahr = NEW.baujahr, entwaesserungsart = NEW.entwaesserungsart, kommentar = NEW.kommentar, knoten_knotentyp = NEW.knoten_knotentyp, knoten_schacht_schachtfunktion = NEW.knoten_schacht_schachtfunktion, knoten_schacht_schachttiefe = NEW.knoten_schacht_schachttiefe, knoten_schacht_einstieghilfe = NEW.knoten_schacht_einstieghilfe, knoten_schacht_arteinstieghilfe = NEW.knoten_schacht_arteinstieghilfe, knoten_schacht_materialsteighilfen = NEW.knoten_schacht_materialsteighilfen, knoten_schacht_innenschutz = NEW.knoten_schacht_innenschutz, knoten_schacht_anzahlanschluesse = NEW.knoten_schacht_anzahlanschluesse, knoten_schacht_uebergabeschacht = NEW.knoten_schacht_uebergabeschacht, knoten_schacht_anzahldeckel = NEW.knoten_schacht_anzahldeckel, knoten_schacht_abdeckung_deckelform = NEW.knoten_schacht_abdeckung_deckelform, knoten_schacht_abdeckung_deckeltyp = NEW.knoten_schacht_abdeckung_deckeltyp, knoten_schacht_abdeckung_laengedeckel = NEW.knoten_schacht_abdeckung_laengedeckel, knoten_schacht_abdeckung_breitedeckel = NEW.knoten_schacht_abdeckung_breitedeckel, knoten_schacht_abdeckung_abdeckungsklasse = NEW.knoten_schacht_abdeckung_abdeckungsklasse, knoten_schacht_abdeckung_materialabdeckung = NEW.knoten_schacht_abdeckung_materialabdeckung, knoten_schacht_abdeckung_anzahlauflageringe = NEW.knoten_schacht_abdeckung_anzahlauflageringe, knoten_schacht_abdeckung_hoeheauflageringe = NEW.knoten_schacht_abdeckung_hoeheauflageringe, knoten_schacht_abdeckung_schmutzfaenger = NEW.knoten_schacht_abdeckung_schmutzfaenger, knoten_schacht_aufbau_aufbauform = NEW.knoten_schacht_aufbau_aufbauform, knoten_schacht_aufbau_abdeckplatte = NEW.knoten_schacht_aufbau_abdeckplatte, knoten_schacht_aufbau_konus = NEW.knoten_schacht_aufbau_konus, knoten_schacht_aufbau_laengeaufbau = NEW.knoten_schacht_aufbau_laengeaufbau, knoten_schacht_aufbau_breiteaufbau = NEW.knoten_schacht_aufbau_breiteaufbau, knoten_schacht_aufbau_hoeheaufbau = NEW.knoten_schacht_aufbau_hoeheaufbau, knoten_schacht_aufbau_materialaufbau = NEW.knoten_schacht_aufbau_materialaufbau, knoten_schacht_untereschachtzone_untereschachtzoneform = NEW.knoten_schacht_untereschachtzone_untereschachtzoneform, knoten_schacht_untereschachtzone_uebergangsplatte = NEW.knoten_schacht_untereschachtzone_uebergangsplatte, knoten_schacht_untereschachtzone_konus = NEW.knoten_schacht_untereschachtzone_konus, knoten_schacht_untereschachtzone_laengeunten = NEW.knoten_schacht_untereschachtzone_laengeunten, knoten_schacht_untereschachtzone_breiteunten = NEW.knoten_schacht_untereschachtzone_breiteunten, knoten_schacht_untereschachtzone_hoeheunten = NEW.knoten_schacht_untereschachtzone_hoeheunten, knoten_schacht_untereschachtzone_materialunten = NEW.knoten_schacht_untereschachtzone_materialunten, knoten_schacht_untereschachtzone_podest = NEW.knoten_schacht_untereschachtzone_podest, knoten_schacht_unterteil_unterteilform = NEW.knoten_schacht_unterteil_unterteilform, knoten_schacht_unterteil_laengeunterteil = NEW.knoten_schacht_unterteil_laengeunterteil, knoten_schacht_unterteil_breiteunterteil = NEW.knoten_schacht_unterteil_breiteunterteil, knoten_schacht_unterteil_hoeheunterteil = NEW.knoten_schacht_unterteil_hoeheunterteil, knoten_schacht_unterteil_materialunterteil = NEW.knoten_schacht_unterteil_materialunterteil, knoten_schacht_unterteil_gerinneform = NEW.knoten_schacht_unterteil_gerinneform, knoten_schacht_unterteil_materialgerinne = NEW.knoten_schacht_unterteil_materialgerinne, knoten_strang = NEW.knoten_strang, lage_strassenschluessel = NEW.lage_strassenschluessel, lage_strassenname = NEW.lage_strassenname, lage_ortsteilschluessel = NEW.lage_ortsteilschluessel, lage_ortsteilname = NEW.lage_ortsteilname, lage_lageoberflaeche = NEW.lage_lageoberflaeche, lage_kommentarlage = NEW.lage_kommentarlage, lage_ueberschwemmungsgebiet = NEW.lage_ueberschwemmungsgebiet, umweltparameter_abwasserart = NEW.umweltparameter_abwasserart, umweltparameter_abwasserartwgs = NEW.umweltparameter_abwasserartwgs, umweltparameter_gwabstand = NEW.umweltparameter_gwabstand, umweltparameter_wasserschutzzone = NEW.umweltparameter_wasserschutzzone, umweltparameter_bodenart = NEW.umweltparameter_bodenart, geometrie_vorlaeufigebezeichnung = NEW.geometrie_vorlaeufigebezeichnung, geometrie_geoobjektart = NEW.geometrie_geoobjektart, geometrie_geoobjekttyp = NEW.geometrie_geoobjekttyp, geometrie_lagegenauigkeitsklasse = NEW.geometrie_lagegenauigkeitsklasse, geometrie_hoehengenauigkeitsklasse = NEW.geometrie_hoehengenauigkeitsklasse, geometrie_datenherkunft = NEW.geometrie_datenherkunft, geometrie_kommentar = NEW.geometrie_kommentar, geometrie_crslage = NEW.geometrie_crslage, sanierung_artmassnahme = NEW.sanierung_artmassnahme
    WHERE 
        ogr_pkid = NEW.ogr_pkid;
    




-- AP Anschlusspunkte: verschiedene Punkte, Anfangs- und/oder Endpunkte von Leitungen, vgl. V106.
CREATE OR REPLACE VIEW qgisybau.v_knoten_ap AS 
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_anschlusspunkt_punktkennung, a.knoten_anschlusspunkt_uebergabepunkt, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 -- G100 2=Knoten
    AND a.knoten_knotentyp = 1 -- G300 1=Anschlusspunkt
    AND a.geometrie_geoobjekttyp::text = 'P'::text -- V200 P=Punktobjekt
    AND p.punktattributabwasser::text <> 'GOK'::text; -- evt. "Höhenpunkt Geländeoberkante" (GOK) ausschließen, da nicht Teil der Anlagen!

COMMENT ON view qgisybau.v_knoten_ap IS 'Anschlusspunkte: verschiedene Punkte, Anfangs- und/oder Endpunkte von Leitungen, vgl. V106.';

CREATE OR REPLACE RULE "Edit-Data" AS
    ON UPDATE TO qgisybau.v_knoten_ap 
    DO INSTEAD 
    
    UPDATE isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage SET
        objektbezeichnung = NEW.objektbezeichnung, objektart = NEW.objektart, alteobjektbezeichnung = NEW.alteobjektbezeichnung, lisa_guid = NEW.lisa_guid, reihenfolgeid = NEW.reihenfolgeid, status = NEW.status, baujahr = NEW.baujahr, entwaesserungsart = NEW.entwaesserungsart, kommentar = NEW.kommentar, knoten_knotentyp = NEW.knoten_knotentyp, knoten_anschlusspunkt_punktkennung = NEW.knoten_anschlusspunkt_punktkennung, knoten_anschlusspunkt_uebergabepunkt = NEW.knoten_anschlusspunkt_uebergabepunkt, knoten_strang = NEW.knoten_strang, lage_strassenschluessel = NEW.lage_strassenschluessel, lage_strassenname = NEW.lage_strassenname, lage_ortsteilschluessel = NEW.lage_ortsteilschluessel, lage_ortsteilname = NEW.lage_ortsteilname, lage_lageoberflaeche = NEW.lage_lageoberflaeche, lage_kommentarlage = NEW.lage_kommentarlage, lage_ueberschwemmungsgebiet = NEW.lage_ueberschwemmungsgebiet, umweltparameter_abwasserart = NEW.umweltparameter_abwasserart, umweltparameter_abwasserartwgs = NEW.umweltparameter_abwasserartwgs, umweltparameter_gwabstand = NEW.umweltparameter_gwabstand, umweltparameter_wasserschutzzone = NEW.umweltparameter_wasserschutzzone, umweltparameter_bodenart = NEW.umweltparameter_bodenart, geometrie_vorlaeufigebezeichnung = NEW.geometrie_vorlaeufigebezeichnung, geometrie_geoobjektart = NEW.geometrie_geoobjektart, geometrie_geoobjekttyp = NEW.geometrie_geoobjekttyp, geometrie_lagegenauigkeitsklasse = NEW.geometrie_lagegenauigkeitsklasse, geometrie_hoehengenauigkeitsklasse = NEW.geometrie_hoehengenauigkeitsklasse, geometrie_datenherkunft = NEW.geometrie_datenherkunft, geometrie_kommentar = NEW.geometrie_kommentar, geometrie_crslage = NEW.geometrie_crslage, sanierung_artmassnahme = NEW.sanierung_artmassnahme
    WHERE 
        ogr_pkid = NEW.ogr_pkid;



-- BW Bauwerke punktförmig: alle Typen, hier keine Differenzierung nach Bauwerkstyp G400
CREATE OR REPLACE VIEW qgisybau.v_knoten_bauwerke AS 
 SELECT 
    a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar, a.knoten_bauwerk_pumpwerk_grundflaeche, a.knoten_bauwerk_pumpwerk_maxlaenge, a.knoten_bauwerk_pumpwerk_maxbreite, a.knoten_bauwerk_pumpwerk_maxhoehe, a.knoten_bauwerk_pumpwerk_raumhochbau, a.knoten_bauwerk_pumpwerk_raumtiefbau, a.knoten_bauwerk_pumpwerk_anzahldeckel, a.knoten_bauwerk_becken_beckenfunktion, a.knoten_bauwerk_becken_beckenart, a.knoten_bauwerk_becken_anordnung, a.knoten_bauwerk_becken_beckenbauart, a.knoten_bauwerk_becken_beckenform, a.knoten_bauwerk_becken_beckenausfuehrung, a.knoten_bauwerk_becken_grundflaeche, a.knoten_bauwerk_becken_maxlaenge, a.knoten_bauwerk_becken_maxbreite, a.knoten_bauwerk_becken_maxhoehe, a.knoten_bauwerk_becken_boeschungsneigung, a.knoten_bauwerk_becken_nutzvolumen, a.knoten_bauwerk_becken_raumhochbau, a.knoten_bauwerk_becken_raumtiefbau, a.knoten_bauwerk_becken_anzahlzulaeufe, a.knoten_bauwerk_becken_anzahlablaeufe, a.knoten_bauwerk_becken_anzahlkammern, a.knoten_bauwerk_becken_anzahldeckel, a.knoten_bauwerk_becken_filterschicht, a.knoten_bauwerk_becken_filtermaterial, a.knoten_bauwerk_becken_bepflanzung, a.knoten_bauwerk_behandlungsanlage_kombinationsanlage, a.knoten_bauwerk_behandlungsanlage_kombinationsart, a.knoten_bauwerk_behandlungsanlage_bypass, b.behandlungsart, b.aufstellungsart, b.breite, b.laenge, b.hoehe, b.hoehezulauf, b.hoeheablauf, b.materialanlage, b.anzahldeckel, b.schlammfang_gesamtspeicher, b.lfabscheider_abscheiderklasse, b.lfabscheider_nenngroesse, b.lfabscheider_schichtdicke, b.lfabscheider_gesamtspeicher, b.lfabscheider_lfspeicher, b.lfabscheider_schwimmerabschluss, b.lfabscheider_warnanlage, b.lfabscheider_kommentarwarnanlage, b.staerkeabscheider_nenngroesse, b.staerkeabscheider_gesamtspeicher, b.staerkeabscheider_frischwasser, b.fettabscheider_nenngroesse, b.fettabscheider_gesamtspeicher, b.emulsionspaltanlage_leistung, b.emulsionspaltanlage_einwohnerwerte, b.emulsionspaltanlage_flockungsmittel, b.stapelbecken_gesamtspeicher, b.stapelbecken_lfspeicher, b.stapelbecken_durchflussleistung, b.stapelbecken_existenzpumpe, b.neutralisationsanlage_neutralisationsart, b.neutralisationsanlage_gesamtvolumen, b.neutralisationsanlage_neutralisationsmittel, b.neutralisationsanlage_phwert, b.neutralisationsanlage_ablaufleistung, a.knoten_bauwerk_klaeranlage_klaeranlagefunktion, a.knoten_bauwerk_klaeranlage_einwohnerwerte, a.knoten_bauwerk_auslaufbauwerk_artauslaufbauwerk, a.knoten_bauwerk_auslaufbauwerk_einleitungsart, a.knoten_bauwerk_auslaufbauwerk_schutzgitter, a.knoten_bauwerk_auslaufbauwerk_sohlsicherung, a.knoten_bauwerk_auslaufbauwerk_boeschungssicherung, a.knoten_bauwerk_auslaufbauwerk_material, a.knoten_bauwerk_auslaufbauwerk_neigung, a.knoten_bauwerk_auslaufbauwerk_laenge, a.knoten_bauwerk_auslaufbauwerk_breite, a.knoten_bauwerk_auslaufbauwerk_hoehe, a.knoten_bauwerk_pumpe_pumpenart, a.knoten_bauwerk_pumpe_foerderhoehegesamt, a.knoten_bauwerk_pumpe_foerderhoehemanometrisch, a.knoten_bauwerk_pumpe_leistungsaufnahme, a.knoten_bauwerk_pumpe_leistung, a.knoten_bauwerk_pumpe_uebergeordnetebauwerk_objektbezeichnung, a.knoten_bauwerk_pumpe_uebergeordnetesbauwerk_anlagentyp, a.knoten_bauwerk_wehr_ueberlauf_wehrfunktion, a.knoten_bauwerk_wehr_ueberlauf_wehrtyp, a.knoten_bauwerk_wehr_ueberlauf_oeffnungsweite, a.knoten_bauwerk_wehr_ueberlauf_schwellenhoehemin, a.knoten_bauwerk_wehr_ueberlauf_schwellenhoehemax, a.knoten_bauwerk_wehr_ueberlauf_laengewehrschwelle, a.knoten_bauwerk_wehr_ueberlauf_artwehrkrone, a.knoten_bauwerk_wehr_ueberlauf_verfahrgeschwindigkeit, a.knoten_bauwerk_wehr_ueberla_uebergeobauwerk_objektbezeichnun, a.knoten_bauwerk_wehr_ueberlauf_uebergeordnebauwerk_anlagentyp, a.knoten_bauwerk_drossel_ablaufart, a.knoten_bauwerk_drossel_nennleistung, a.knoten_bauwerk_drossel_uebergeordnebauwerk_objektbezeichnung, a.knoten_bauwerk_drossel_uebergeordnetesbauwerk_anlagentyp, a.knoten_bauwerk_schieber_schieberfunktion, a.knoten_bauwerk_schieber_schieberart, a.knoten_bauwerk_schieber_schieberbreite, a.knoten_bauwerk_schieber_schiebernulllage, a.knoten_bauwerk_schieber_hubhoehemax, a.knoten_bauwerk_schieber_verfahrgeschwindigkeit, a.knoten_bauwerk_schieber_uebergeordnbauwerk_objektbezeichnung, a.knoten_bauwerk_schieber_uebergeordnetesbauwerk_anlagentyp, a.knoten_bauwerk_rechen_rechentyp, a.knoten_bauwerk_rechen_rechenrost, a.knoten_bauwerk_rechen_aufstellungsart, a.knoten_bauwerk_rechen_breite, a.knoten_bauwerk_rechen_laenge, a.knoten_bauwerk_rechen_hoehe, a.knoten_bauwerk_rechen_reinigereingriff, a.knoten_bauwerk_rechen_material, a.knoten_bauwerk_rechen_uebergeordnetbauwerk_objektbezeichnung, a.knoten_bauwerk_rechen_uebergeordnetesbauwerk_anlagentyp, a.knoten_bauwerk_sieb_siebtyp, a.knoten_bauwerk_sieb_siebkoerper, a.knoten_bauwerk_sieb_aufstellungsart, a.knoten_bauwerk_sieb_einbauart, a.knoten_bauwerk_sieb_siebflaeche, a.knoten_bauwerk_sieb_material, a.knoten_bauwerk_sieb_uebergeordnetesbauwerk_objektbezeichnung, a.knoten_bauwerk_sieb_uebergeordnetesbauwerk_anlagentyp, a.knoten_bauwerk_versickerungsanlage_versickerungsanlagetyp, a.knoten_bauwerk_versickerungsanlage_datuminbetriebnahme, a.knoten_bauwerk_versickerungsanlage_artflaechenanschluss, a.knoten_bauwerk_versickerungsanlage_maxversickerungsleistung, a.knoten_bauwerk_versickerungsanlage_bemessungshaeufigkeit, a.knoten_bauwerk_versickerungsanlage_umfeld, a.knoten_bauwerk_versickerungsanlage_mulde_teich_laenge, a.knoten_bauwerk_versickerungsanlage_mulde_teich_breite, a.knoten_bauwerk_versickerungsanlage_mulde_teich_tiefe, a.knoten_bauwerk_versickerungsanlag_mulde_teich_grundflaecheva, a.knoten_bauwerk_versickerungsanl_mulde_teich_flaechedauerstau, a.knoten_bauwerk_versickerungsanlag_mulde_teich_hoehedauerstau, a.knoten_bauwerk_versickerungsanlage_mulde_teich_boeschungva, a.knoten_bauwerk_versickerungs_mulde_teich_staerkebodenschicht, a.knoten_bauwerk_versickerungsanla_mulde_teich_maxeinstauhoehe, a.knoten_bauwerk_versickerungsanla_mulde_teich_speichervolumen, a.knoten_bauwerk_versickerungsan_mulde_teich_existenzueberlauf, a.knoten_bauwerk_versickerungsanlage_mulde_teich_ueberlauf, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_laenge, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_breite, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_tiefe, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrva, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_anzahlrohre, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrmaterial, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_fuellmaterial, a.knoten_bauwerk_versickerungsanla_rohr_rigole_speichervolumen, a.knoten_bauwerk_versickerungs_rohr_rigole_speicherkoeffizient, a.knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselabfluss, a.knoten_bauwerk_versickeru_rohr_rigole_existenzdrosselschacht, a.knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselschacht, a.knoten_bauwerk_versickerungsan_rohr_rigole_existenzueberlauf, a.knoten_bauwerk_versickerungsanlage_rohr_rigole_ueberlauf, a.knoten_bauwerk_versickerungsanl_versickerungssch_vschachttyp, a.knoten_bauwerk_versickerungsanlag_versickerungsschach_laenge, a.knoten_bauwerk_versickerungsanlag_versickerungsschach_breite, a.knoten_bauwerk_versickerungsanlage_versickerungsschach_tiefe, a.knoten_bauwerk_versickerungsa_versickerungssc_grundflaecheva, a.knoten_bauwerk_versickerungsan_versickerungssc_fuellmaterial, a.knoten_bauwerk_versickerung_versickerungs_existenzfiltersack, a.knoten_bauwerk_versickerungsa_versickerungss_maxeinstauhoehe, a.knoten_bauwerk_versickerungsa_versickerungss_speichervolumen, a.knoten_bauwerk_versickerungsa_versickerungssc_drosselabfluss, a.knoten_bauwerk_versickerungs_versickerungs_existenzueberlau1, a.knoten_bauwerk_versickerungsanla_versickerungsscha_ueberlauf, a.knoten_bauwerk_versickerungsanlag_versickerungsflaech_laenge, a.knoten_bauwerk_versickerungsanlag_versickerungsflaech_breite, a.knoten_bauwerk_versickerungs_versickerungs_existenzueberlau2, a.knoten_bauwerk_versickerungsanla_versickerungsflae_ueberlauf, a.knoten_bauwerk_zisterne_regenwassernutzungfunktion, a.knoten_bauwerk_zisterne_laenge, a.knoten_bauwerk_zisterne_breite, a.knoten_bauwerk_zisterne_tiefe, a.knoten_bauwerk_zisterne_hoehe, a.knoten_bauwerk_zisterne_durchmesser, a.knoten_bauwerk_zisterne_grundflaechern, a.knoten_bauwerk_zisterne_bauart, a.knoten_bauwerk_zisterne_materialrn, a.knoten_bauwerk_zisterne_filterart, a.knoten_bauwerk_zisterne_artflaechenanschluss, a.knoten_bauwerk_zisterne_angeschlosseneflaeche, a.knoten_bauwerk_zisterne_volumennutzbar, a.knoten_bauwerk_zisterne_rueckhaltevolumen, a.knoten_bauwerk_zisterne_drosselabfluss, a.knoten_bauwerk_zisterne_anzahldeckel, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     LEFT JOIN isybau.ident_daten_stamm_abwasanlag_knote_bauwe_behan_anlage_anlage b ON a.ogr_pkid::text = b.parent_ogr_pkid::text
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 -- G100 2=Knoten
    AND a.knoten_knotentyp = 2 -- G300 2=Bauwerk
    AND a.geometrie_geoobjekttyp::text = 'P'::text -- V200 P=Punktobjekt
    AND (p.punktattributabwasser::text <> ALL (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text])); -- "Deckel/Einstieg Sonderbauwerk" und "Deckelmittelpunkte" ausschließen! (s.u.) 

COMMENT ON view qgisybau.v_knoten_bauwerke IS 'Bauwerke punktförmig: alle Typen, hier keine Differenzierung nach Bauwerkstyp G400';

CREATE OR REPLACE RULE "Edit-Data" AS
    ON UPDATE TO qgisybau.v_knoten_bauwerke  
    DO INSTEAD 
    (
    UPDATE isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage SET
            objektbezeichnung = NEW.objektbezeichnung, objektart = NEW.objektart, alteobjektbezeichnung = NEW.alteobjektbezeichnung, lisa_guid = NEW.lisa_guid, reihenfolgeid = NEW.reihenfolgeid, status = NEW.status, baujahr = NEW.baujahr, entwaesserungsart = NEW.entwaesserungsart, kommentar = NEW.kommentar, knoten_knotentyp = NEW.knoten_knotentyp, knoten_bauwerk_bauwerkstyp = NEW.knoten_bauwerk_bauwerkstyp, knoten_bauwerk_hersteller_typ = NEW.knoten_bauwerk_hersteller_typ, knoten_bauwerk_adressehersteller = NEW.knoten_bauwerk_adressehersteller, knoten_bauwerk_ufis_baunummer = NEW.knoten_bauwerk_ufis_baunummer, knoten_bauwerk_uebergabebauwerk = NEW.knoten_bauwerk_uebergabebauwerk, knoten_bauwerk_kommentar = NEW.knoten_bauwerk_kommentar, knoten_bauwerk_pumpwerk_grundflaeche = NEW.knoten_bauwerk_pumpwerk_grundflaeche, knoten_bauwerk_pumpwerk_maxlaenge = NEW.knoten_bauwerk_pumpwerk_maxlaenge, knoten_bauwerk_pumpwerk_maxbreite = NEW.knoten_bauwerk_pumpwerk_maxbreite, knoten_bauwerk_pumpwerk_maxhoehe = NEW.knoten_bauwerk_pumpwerk_maxhoehe, knoten_bauwerk_pumpwerk_raumhochbau = NEW.knoten_bauwerk_pumpwerk_raumhochbau, knoten_bauwerk_pumpwerk_raumtiefbau = NEW.knoten_bauwerk_pumpwerk_raumtiefbau, knoten_bauwerk_pumpwerk_anzahldeckel = NEW.knoten_bauwerk_pumpwerk_anzahldeckel, knoten_bauwerk_becken_beckenfunktion = NEW.knoten_bauwerk_becken_beckenfunktion, knoten_bauwerk_becken_beckenart = NEW.knoten_bauwerk_becken_beckenart, knoten_bauwerk_becken_anordnung = NEW.knoten_bauwerk_becken_anordnung, knoten_bauwerk_becken_beckenbauart = NEW.knoten_bauwerk_becken_beckenbauart, knoten_bauwerk_becken_beckenform = NEW.knoten_bauwerk_becken_beckenform, knoten_bauwerk_becken_beckenausfuehrung = NEW.knoten_bauwerk_becken_beckenausfuehrung, knoten_bauwerk_becken_grundflaeche = NEW.knoten_bauwerk_becken_grundflaeche, knoten_bauwerk_becken_maxlaenge = NEW.knoten_bauwerk_becken_maxlaenge, knoten_bauwerk_becken_maxbreite = NEW.knoten_bauwerk_becken_maxbreite, knoten_bauwerk_becken_maxhoehe = NEW.knoten_bauwerk_becken_maxhoehe, knoten_bauwerk_becken_boeschungsneigung = NEW.knoten_bauwerk_becken_boeschungsneigung, knoten_bauwerk_becken_nutzvolumen = NEW.knoten_bauwerk_becken_nutzvolumen, knoten_bauwerk_becken_raumhochbau = NEW.knoten_bauwerk_becken_raumhochbau, knoten_bauwerk_becken_raumtiefbau = NEW.knoten_bauwerk_becken_raumtiefbau, knoten_bauwerk_becken_anzahlzulaeufe = NEW.knoten_bauwerk_becken_anzahlzulaeufe, knoten_bauwerk_becken_anzahlablaeufe = NEW.knoten_bauwerk_becken_anzahlablaeufe, knoten_bauwerk_becken_anzahlkammern = NEW.knoten_bauwerk_becken_anzahlkammern, knoten_bauwerk_becken_anzahldeckel = NEW.knoten_bauwerk_becken_anzahldeckel, knoten_bauwerk_becken_filterschicht = NEW.knoten_bauwerk_becken_filterschicht, knoten_bauwerk_becken_filtermaterial = NEW.knoten_bauwerk_becken_filtermaterial, knoten_bauwerk_becken_bepflanzung = NEW.knoten_bauwerk_becken_bepflanzung, knoten_bauwerk_behandlungsanlage_kombinationsanlage = NEW.knoten_bauwerk_behandlungsanlage_kombinationsanlage, knoten_bauwerk_behandlungsanlage_kombinationsart = NEW.knoten_bauwerk_behandlungsanlage_kombinationsart, knoten_bauwerk_behandlungsanlage_bypass = NEW.knoten_bauwerk_behandlungsanlage_bypass, knoten_bauwerk_klaeranlage_klaeranlagefunktion = NEW.knoten_bauwerk_klaeranlage_klaeranlagefunktion, knoten_bauwerk_klaeranlage_einwohnerwerte = NEW.knoten_bauwerk_klaeranlage_einwohnerwerte, knoten_bauwerk_auslaufbauwerk_artauslaufbauwerk = NEW.knoten_bauwerk_auslaufbauwerk_artauslaufbauwerk, knoten_bauwerk_auslaufbauwerk_einleitungsart = NEW.knoten_bauwerk_auslaufbauwerk_einleitungsart, knoten_bauwerk_auslaufbauwerk_schutzgitter = NEW.knoten_bauwerk_auslaufbauwerk_schutzgitter, knoten_bauwerk_auslaufbauwerk_sohlsicherung = NEW.knoten_bauwerk_auslaufbauwerk_sohlsicherung, knoten_bauwerk_auslaufbauwerk_boeschungssicherung = NEW.knoten_bauwerk_auslaufbauwerk_boeschungssicherung, knoten_bauwerk_auslaufbauwerk_material = NEW.knoten_bauwerk_auslaufbauwerk_material, knoten_bauwerk_auslaufbauwerk_neigung = NEW.knoten_bauwerk_auslaufbauwerk_neigung, knoten_bauwerk_auslaufbauwerk_laenge = NEW.knoten_bauwerk_auslaufbauwerk_laenge, knoten_bauwerk_auslaufbauwerk_breite = NEW.knoten_bauwerk_auslaufbauwerk_breite, knoten_bauwerk_auslaufbauwerk_hoehe = NEW.knoten_bauwerk_auslaufbauwerk_hoehe, knoten_bauwerk_pumpe_pumpenart = NEW.knoten_bauwerk_pumpe_pumpenart, knoten_bauwerk_pumpe_foerderhoehegesamt = NEW.knoten_bauwerk_pumpe_foerderhoehegesamt, knoten_bauwerk_pumpe_foerderhoehemanometrisch = NEW.knoten_bauwerk_pumpe_foerderhoehemanometrisch, knoten_bauwerk_pumpe_leistungsaufnahme = NEW.knoten_bauwerk_pumpe_leistungsaufnahme, knoten_bauwerk_pumpe_leistung = NEW.knoten_bauwerk_pumpe_leistung, knoten_bauwerk_pumpe_uebergeordnetebauwerk_objektbezeichnung = NEW.knoten_bauwerk_pumpe_uebergeordnetebauwerk_objektbezeichnung, knoten_bauwerk_pumpe_uebergeordnetesbauwerk_anlagentyp = NEW.knoten_bauwerk_pumpe_uebergeordnetesbauwerk_anlagentyp, knoten_bauwerk_wehr_ueberlauf_wehrfunktion = NEW.knoten_bauwerk_wehr_ueberlauf_wehrfunktion, knoten_bauwerk_wehr_ueberlauf_wehrtyp = NEW.knoten_bauwerk_wehr_ueberlauf_wehrtyp, knoten_bauwerk_wehr_ueberlauf_oeffnungsweite = NEW.knoten_bauwerk_wehr_ueberlauf_oeffnungsweite, knoten_bauwerk_wehr_ueberlauf_schwellenhoehemin = NEW.knoten_bauwerk_wehr_ueberlauf_schwellenhoehemin, knoten_bauwerk_wehr_ueberlauf_schwellenhoehemax = NEW.knoten_bauwerk_wehr_ueberlauf_schwellenhoehemax, knoten_bauwerk_wehr_ueberlauf_laengewehrschwelle = NEW.knoten_bauwerk_wehr_ueberlauf_laengewehrschwelle, knoten_bauwerk_wehr_ueberlauf_artwehrkrone = NEW.knoten_bauwerk_wehr_ueberlauf_artwehrkrone, knoten_bauwerk_wehr_ueberlauf_verfahrgeschwindigkeit = NEW.knoten_bauwerk_wehr_ueberlauf_verfahrgeschwindigkeit, knoten_bauwerk_wehr_ueberla_uebergeobauwerk_objektbezeichnun = NEW.knoten_bauwerk_wehr_ueberla_uebergeobauwerk_objektbezeichnun, knoten_bauwerk_wehr_ueberlauf_uebergeordnebauwerk_anlagentyp = NEW.knoten_bauwerk_wehr_ueberlauf_uebergeordnebauwerk_anlagentyp, knoten_bauwerk_drossel_ablaufart = NEW.knoten_bauwerk_drossel_ablaufart, knoten_bauwerk_drossel_nennleistung = NEW.knoten_bauwerk_drossel_nennleistung, knoten_bauwerk_drossel_uebergeordnebauwerk_objektbezeichnung = NEW.knoten_bauwerk_drossel_uebergeordnebauwerk_objektbezeichnung, knoten_bauwerk_drossel_uebergeordnetesbauwerk_anlagentyp = NEW.knoten_bauwerk_drossel_uebergeordnetesbauwerk_anlagentyp, knoten_bauwerk_schieber_schieberfunktion = NEW.knoten_bauwerk_schieber_schieberfunktion, knoten_bauwerk_schieber_schieberart = NEW.knoten_bauwerk_schieber_schieberart, knoten_bauwerk_schieber_schieberbreite = NEW.knoten_bauwerk_schieber_schieberbreite, knoten_bauwerk_schieber_schiebernulllage = NEW.knoten_bauwerk_schieber_schiebernulllage, knoten_bauwerk_schieber_hubhoehemax = NEW.knoten_bauwerk_schieber_hubhoehemax, knoten_bauwerk_schieber_verfahrgeschwindigkeit = NEW.knoten_bauwerk_schieber_verfahrgeschwindigkeit, knoten_bauwerk_schieber_uebergeordnbauwerk_objektbezeichnung = NEW.knoten_bauwerk_schieber_uebergeordnbauwerk_objektbezeichnung, knoten_bauwerk_schieber_uebergeordnetesbauwerk_anlagentyp = NEW.knoten_bauwerk_schieber_uebergeordnetesbauwerk_anlagentyp, knoten_bauwerk_rechen_rechentyp = NEW.knoten_bauwerk_rechen_rechentyp, knoten_bauwerk_rechen_rechenrost = NEW.knoten_bauwerk_rechen_rechenrost, knoten_bauwerk_rechen_aufstellungsart = NEW.knoten_bauwerk_rechen_aufstellungsart, knoten_bauwerk_rechen_breite = NEW.knoten_bauwerk_rechen_breite, knoten_bauwerk_rechen_laenge = NEW.knoten_bauwerk_rechen_laenge, knoten_bauwerk_rechen_hoehe = NEW.knoten_bauwerk_rechen_hoehe, knoten_bauwerk_rechen_reinigereingriff = NEW.knoten_bauwerk_rechen_reinigereingriff, knoten_bauwerk_rechen_material = NEW.knoten_bauwerk_rechen_material, knoten_bauwerk_rechen_uebergeordnetbauwerk_objektbezeichnung = NEW.knoten_bauwerk_rechen_uebergeordnetbauwerk_objektbezeichnung, knoten_bauwerk_rechen_uebergeordnetesbauwerk_anlagentyp = NEW.knoten_bauwerk_rechen_uebergeordnetesbauwerk_anlagentyp, knoten_bauwerk_sieb_siebtyp = NEW.knoten_bauwerk_sieb_siebtyp, knoten_bauwerk_sieb_siebkoerper = NEW.knoten_bauwerk_sieb_siebkoerper, knoten_bauwerk_sieb_aufstellungsart = NEW.knoten_bauwerk_sieb_aufstellungsart, knoten_bauwerk_sieb_einbauart = NEW.knoten_bauwerk_sieb_einbauart, knoten_bauwerk_sieb_siebflaeche = NEW.knoten_bauwerk_sieb_siebflaeche, knoten_bauwerk_sieb_material = NEW.knoten_bauwerk_sieb_material, knoten_bauwerk_sieb_uebergeordnetesbauwerk_objektbezeichnung = NEW.knoten_bauwerk_sieb_uebergeordnetesbauwerk_objektbezeichnung, knoten_bauwerk_sieb_uebergeordnetesbauwerk_anlagentyp = NEW.knoten_bauwerk_sieb_uebergeordnetesbauwerk_anlagentyp, knoten_bauwerk_versickerungsanlage_versickerungsanlagetyp = NEW.knoten_bauwerk_versickerungsanlage_versickerungsanlagetyp, knoten_bauwerk_versickerungsanlage_datuminbetriebnahme = NEW.knoten_bauwerk_versickerungsanlage_datuminbetriebnahme, knoten_bauwerk_versickerungsanlage_artflaechenanschluss = NEW.knoten_bauwerk_versickerungsanlage_artflaechenanschluss, knoten_bauwerk_versickerungsanlage_maxversickerungsleistung = NEW.knoten_bauwerk_versickerungsanlage_maxversickerungsleistung, knoten_bauwerk_versickerungsanlage_bemessungshaeufigkeit = NEW.knoten_bauwerk_versickerungsanlage_bemessungshaeufigkeit, knoten_bauwerk_versickerungsanlage_umfeld = NEW.knoten_bauwerk_versickerungsanlage_umfeld, knoten_bauwerk_versickerungsanlage_mulde_teich_laenge = NEW.knoten_bauwerk_versickerungsanlage_mulde_teich_laenge, knoten_bauwerk_versickerungsanlage_mulde_teich_breite = NEW.knoten_bauwerk_versickerungsanlage_mulde_teich_breite, knoten_bauwerk_versickerungsanlage_mulde_teich_tiefe = NEW.knoten_bauwerk_versickerungsanlage_mulde_teich_tiefe, knoten_bauwerk_versickerungsanlag_mulde_teich_grundflaecheva = NEW.knoten_bauwerk_versickerungsanlag_mulde_teich_grundflaecheva, knoten_bauwerk_versickerungsanl_mulde_teich_flaechedauerstau = NEW.knoten_bauwerk_versickerungsanl_mulde_teich_flaechedauerstau, knoten_bauwerk_versickerungsanlag_mulde_teich_hoehedauerstau = NEW.knoten_bauwerk_versickerungsanlag_mulde_teich_hoehedauerstau, knoten_bauwerk_versickerungsanlage_mulde_teich_boeschungva = NEW.knoten_bauwerk_versickerungsanlage_mulde_teich_boeschungva, knoten_bauwerk_versickerungs_mulde_teich_staerkebodenschicht = NEW.knoten_bauwerk_versickerungs_mulde_teich_staerkebodenschicht, knoten_bauwerk_versickerungsanla_mulde_teich_maxeinstauhoehe = NEW.knoten_bauwerk_versickerungsanla_mulde_teich_maxeinstauhoehe, knoten_bauwerk_versickerungsanla_mulde_teich_speichervolumen = NEW.knoten_bauwerk_versickerungsanla_mulde_teich_speichervolumen, knoten_bauwerk_versickerungsan_mulde_teich_existenzueberlauf = NEW.knoten_bauwerk_versickerungsan_mulde_teich_existenzueberlauf, knoten_bauwerk_versickerungsanlage_mulde_teich_ueberlauf = NEW.knoten_bauwerk_versickerungsanlage_mulde_teich_ueberlauf, knoten_bauwerk_versickerungsanlage_rohr_rigole_laenge = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_laenge, knoten_bauwerk_versickerungsanlage_rohr_rigole_breite = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_breite, knoten_bauwerk_versickerungsanlage_rohr_rigole_tiefe = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_tiefe, knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrva = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrva, knoten_bauwerk_versickerungsanlage_rohr_rigole_anzahlrohre = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_anzahlrohre, knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrmaterial = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_rohrmaterial, knoten_bauwerk_versickerungsanlage_rohr_rigole_fuellmaterial = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_fuellmaterial, knoten_bauwerk_versickerungsanla_rohr_rigole_speichervolumen = NEW.knoten_bauwerk_versickerungsanla_rohr_rigole_speichervolumen, knoten_bauwerk_versickerungs_rohr_rigole_speicherkoeffizient = NEW.knoten_bauwerk_versickerungs_rohr_rigole_speicherkoeffizient, knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselabfluss = NEW.knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselabfluss, knoten_bauwerk_versickeru_rohr_rigole_existenzdrosselschacht = NEW.knoten_bauwerk_versickeru_rohr_rigole_existenzdrosselschacht, knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselschacht = NEW.knoten_bauwerk_versickerungsanlag_rohr_rigole_drosselschacht, knoten_bauwerk_versickerungsan_rohr_rigole_existenzueberlauf = NEW.knoten_bauwerk_versickerungsan_rohr_rigole_existenzueberlauf, knoten_bauwerk_versickerungsanlage_rohr_rigole_ueberlauf = NEW.knoten_bauwerk_versickerungsanlage_rohr_rigole_ueberlauf, knoten_bauwerk_versickerungsanl_versickerungssch_vschachttyp = NEW.knoten_bauwerk_versickerungsanl_versickerungssch_vschachttyp, knoten_bauwerk_versickerungsanlag_versickerungsschach_laenge = NEW.knoten_bauwerk_versickerungsanlag_versickerungsschach_laenge, knoten_bauwerk_versickerungsanlag_versickerungsschach_breite = NEW.knoten_bauwerk_versickerungsanlag_versickerungsschach_breite, knoten_bauwerk_versickerungsanlage_versickerungsschach_tiefe = NEW.knoten_bauwerk_versickerungsanlage_versickerungsschach_tiefe, knoten_bauwerk_versickerungsa_versickerungssc_grundflaecheva = NEW.knoten_bauwerk_versickerungsa_versickerungssc_grundflaecheva, knoten_bauwerk_versickerungsan_versickerungssc_fuellmaterial = NEW.knoten_bauwerk_versickerungsan_versickerungssc_fuellmaterial, knoten_bauwerk_versickerung_versickerungs_existenzfiltersack = NEW.knoten_bauwerk_versickerung_versickerungs_existenzfiltersack, knoten_bauwerk_versickerungsa_versickerungss_maxeinstauhoehe = NEW.knoten_bauwerk_versickerungsa_versickerungss_maxeinstauhoehe, knoten_bauwerk_versickerungsa_versickerungss_speichervolumen = NEW.knoten_bauwerk_versickerungsa_versickerungss_speichervolumen, knoten_bauwerk_versickerungsa_versickerungssc_drosselabfluss = NEW.knoten_bauwerk_versickerungsa_versickerungssc_drosselabfluss, knoten_bauwerk_versickerungs_versickerungs_existenzueberlau1 = NEW.knoten_bauwerk_versickerungs_versickerungs_existenzueberlau1, knoten_bauwerk_versickerungsanla_versickerungsscha_ueberlauf = NEW.knoten_bauwerk_versickerungsanla_versickerungsscha_ueberlauf, knoten_bauwerk_versickerungsanlag_versickerungsflaech_laenge = NEW.knoten_bauwerk_versickerungsanlag_versickerungsflaech_laenge, knoten_bauwerk_versickerungsanlag_versickerungsflaech_breite = NEW.knoten_bauwerk_versickerungsanlag_versickerungsflaech_breite, knoten_bauwerk_versickerungs_versickerungs_existenzueberlau2 = NEW.knoten_bauwerk_versickerungs_versickerungs_existenzueberlau2, knoten_bauwerk_versickerungsanla_versickerungsflae_ueberlauf = NEW.knoten_bauwerk_versickerungsanla_versickerungsflae_ueberlauf, knoten_bauwerk_zisterne_regenwassernutzungfunktion = NEW.knoten_bauwerk_zisterne_regenwassernutzungfunktion, knoten_bauwerk_zisterne_laenge = NEW.knoten_bauwerk_zisterne_laenge, knoten_bauwerk_zisterne_breite = NEW.knoten_bauwerk_zisterne_breite, knoten_bauwerk_zisterne_tiefe = NEW.knoten_bauwerk_zisterne_tiefe, knoten_bauwerk_zisterne_hoehe = NEW.knoten_bauwerk_zisterne_hoehe, knoten_bauwerk_zisterne_durchmesser = NEW.knoten_bauwerk_zisterne_durchmesser, knoten_bauwerk_zisterne_grundflaechern = NEW.knoten_bauwerk_zisterne_grundflaechern, knoten_bauwerk_zisterne_bauart = NEW.knoten_bauwerk_zisterne_bauart, knoten_bauwerk_zisterne_materialrn = NEW.knoten_bauwerk_zisterne_materialrn, knoten_bauwerk_zisterne_filterart = NEW.knoten_bauwerk_zisterne_filterart, knoten_bauwerk_zisterne_artflaechenanschluss = NEW.knoten_bauwerk_zisterne_artflaechenanschluss, knoten_bauwerk_zisterne_angeschlosseneflaeche = NEW.knoten_bauwerk_zisterne_angeschlosseneflaeche, knoten_bauwerk_zisterne_volumennutzbar = NEW.knoten_bauwerk_zisterne_volumennutzbar, knoten_bauwerk_zisterne_rueckhaltevolumen = NEW.knoten_bauwerk_zisterne_rueckhaltevolumen, knoten_bauwerk_zisterne_drosselabfluss = NEW.knoten_bauwerk_zisterne_drosselabfluss, knoten_bauwerk_zisterne_anzahldeckel = NEW.knoten_bauwerk_zisterne_anzahldeckel, knoten_strang = NEW.knoten_strang, lage_strassenschluessel = NEW.lage_strassenschluessel, lage_strassenname = NEW.lage_strassenname, lage_ortsteilschluessel = NEW.lage_ortsteilschluessel, lage_ortsteilname = NEW.lage_ortsteilname, lage_lageoberflaeche = NEW.lage_lageoberflaeche, lage_kommentarlage = NEW.lage_kommentarlage, lage_ueberschwemmungsgebiet = NEW.lage_ueberschwemmungsgebiet, umweltparameter_abwasserart = NEW.umweltparameter_abwasserart, umweltparameter_abwasserartwgs = NEW.umweltparameter_abwasserartwgs, umweltparameter_gwabstand = NEW.umweltparameter_gwabstand, umweltparameter_wasserschutzzone = NEW.umweltparameter_wasserschutzzone, umweltparameter_bodenart = NEW.umweltparameter_bodenart, geometrie_vorlaeufigebezeichnung = NEW.geometrie_vorlaeufigebezeichnung, geometrie_geoobjektart = NEW.geometrie_geoobjektart, geometrie_geoobjekttyp = NEW.geometrie_geoobjekttyp, geometrie_lagegenauigkeitsklasse = NEW.geometrie_lagegenauigkeitsklasse, geometrie_hoehengenauigkeitsklasse = NEW.geometrie_hoehengenauigkeitsklasse, geometrie_datenherkunft = NEW.geometrie_datenherkunft, geometrie_kommentar = NEW.geometrie_kommentar, geometrie_crslage = NEW.geometrie_crslage, sanierung_artmassnahme = NEW.sanierung_artmassnahme
    WHERE 
        ogr_pkid = NEW.ogr_pkid;
    
    
    UPDATE isybau.ident_daten_stamm_abwasanlag_knote_bauwe_behan_anlage_anlage SET
            behandlungsart = NEW.behandlungsart, aufstellungsart = NEW.aufstellungsart, breite = NEW.breite, laenge = NEW.laenge, hoehe = NEW.hoehe, hoehezulauf = NEW.hoehezulauf, hoeheablauf = NEW.hoeheablauf, materialanlage = NEW.materialanlage, anzahldeckel = NEW.anzahldeckel, schlammfang_gesamtspeicher = NEW.schlammfang_gesamtspeicher, lfabscheider_abscheiderklasse = NEW.lfabscheider_abscheiderklasse, lfabscheider_nenngroesse = NEW.lfabscheider_nenngroesse, lfabscheider_schichtdicke = NEW.lfabscheider_schichtdicke, lfabscheider_gesamtspeicher = NEW.lfabscheider_gesamtspeicher, lfabscheider_lfspeicher = NEW.lfabscheider_lfspeicher, lfabscheider_schwimmerabschluss = NEW.lfabscheider_schwimmerabschluss, lfabscheider_warnanlage = NEW.lfabscheider_warnanlage, lfabscheider_kommentarwarnanlage = NEW.lfabscheider_kommentarwarnanlage, staerkeabscheider_nenngroesse = NEW.staerkeabscheider_nenngroesse, staerkeabscheider_gesamtspeicher = NEW.staerkeabscheider_gesamtspeicher, staerkeabscheider_frischwasser = NEW.staerkeabscheider_frischwasser, fettabscheider_nenngroesse = NEW.fettabscheider_nenngroesse, fettabscheider_gesamtspeicher = NEW.fettabscheider_gesamtspeicher, emulsionspaltanlage_leistung = NEW.emulsionspaltanlage_leistung, emulsionspaltanlage_einwohnerwerte = NEW.emulsionspaltanlage_einwohnerwerte, emulsionspaltanlage_flockungsmittel = NEW.emulsionspaltanlage_flockungsmittel, stapelbecken_gesamtspeicher = NEW.stapelbecken_gesamtspeicher, stapelbecken_lfspeicher = NEW.stapelbecken_lfspeicher, stapelbecken_durchflussleistung = NEW.stapelbecken_durchflussleistung, stapelbecken_existenzpumpe = NEW.stapelbecken_existenzpumpe, neutralisationsanlage_neutralisationsart = NEW.neutralisationsanlage_neutralisationsart, neutralisationsanlage_gesamtvolumen = NEW.neutralisationsanlage_gesamtvolumen, neutralisationsanlage_neutralisationsmittel = NEW.neutralisationsanlage_neutralisationsmittel, neutralisationsanlage_phwert = NEW.neutralisationsanlage_phwert, neutralisationsanlage_ablaufleistung = NEW.neutralisationsanlage_ablaufleistung
    WHERE 
        parent_ogr_pkid = NEW.ogr_pkid;
    )




/* optionale Erweiterung */
-- Deckel/Abdeckung: alle Arten von Deckeln und Einstiegs-Abdeckungen. Kein Objekt im ISYBAU Modell aber hilfreich für Kartendarstellung und notwendig zur Vermeidung von Multipart-/Geometrycollection-Objekten.
CREATE OR REPLACE VIEW qgisybau.v_deckel AS 
-- Schachtabdeckung 1:1
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar, a.knoten_schacht_abdeckung_deckelform AS deckelform, a.knoten_schacht_abdeckung_deckeltyp AS deckeltyp, a.knoten_schacht_abdeckung_laengedeckel AS laengedeckel, a.knoten_schacht_abdeckung_breitedeckel AS breitedeckel, a.knoten_schacht_abdeckung_abdeckungsklasse AS abdeckungsklasse, a.knoten_schacht_abdeckung_materialabdeckung AS materialabdeckung, a.knoten_schacht_abdeckung_schmutzfaenger AS schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 0 
    AND a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text])) -- beide DeckelAttribute um evt. Fehler aufzufangen.
UNION ALL
-- Abdeckung von Versickerungsanlagen 1:1
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar, a.knoten_bauwerk_versickerun_versickerung_abdeckung_deckelform AS deckelform, a.knoten_bauwerk_versickerung_versickerung_abdeckung_deckeltyp AS deckeltyp, a.knoten_bauwerk_versickeru_versickerun_abdeckung_laengedeckel AS laengedeckel, a.knoten_bauwerk_versickeru_versickerun_abdeckung_breitedeckel AS breitedeckel, a.knoten_bauwerk_versicke_versicker_abdeckung_abdeckungsklasse AS abdeckungsklasse, a.knoten_bauwerk_versicke_versicke_abdeckung_materialabdeckung AS materialabdeckung, a.knoten_bauwerk_versicker_versickeru_abdeckung_schmutzfaenger AS schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 2 
    AND a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text]))
UNION ALL
-- Für die Bauwerkstypen Pumpwerk, Becken, Behandlungsanlage und Zisterne können jeweils 1:n Deckel dokumentiert sein. 
-- Becken
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar,
    d.deckelform,
    d.deckeltyp,
    d.laengedeckel,
    d.breitedeckel,
    d.abdeckungsklasse,
    d.materialabdeckung,
    d.schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     RIGHT JOIN isybau.ident_datenk_stammd_abwassanlage_knoten_bauwer_becken_deckel d ON a.ogr_pkid::text = d.parent_ogr_pkid::text -- Becken
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 2 
    AND a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text])) -- beide Deckelattribute um evt. Fehler aufzufangen.
UNION ALL
-- Pumpwerk
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar,
    d.deckelform,
    d.deckeltyp,
    d.laengedeckel,
    d.breitedeckel,
    d.abdeckungsklasse,
    d.materialabdeckung,
    d.schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     RIGHT JOIN isybau.ident_datenk_stammd_abwassanlage_knoten_bauwer_pumpwe_deckel d ON a.ogr_pkid::text = d.parent_ogr_pkid::text -- Pumpwerk
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 2 
    and a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text]))
UNION ALL
-- Zisterne
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar,
    d.deckelform,
    d.deckeltyp,
    d.laengedeckel,
    d.breitedeckel,
    d.abdeckungsklasse,
    d.materialabdeckung,
    d.schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     RIGHT JOIN isybau.ident_datenk_stammd_abwassanlage_knoten_bauwer_zister_deckel d ON a.ogr_pkid::text = d.parent_ogr_pkid::text -- Zisterne
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 2 
    and a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text]))
UNION ALL
-- Behandlungsanlage
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.knoten_knotentyp, a.knoten_bauwerk_bauwerkstyp, a.knoten_bauwerk_hersteller_typ, a.knoten_bauwerk_adressehersteller, a.knoten_bauwerk_ufis_baunummer, a.knoten_bauwerk_uebergabebauwerk, a.knoten_bauwerk_kommentar,
    d.deckelform,
    d.deckeltyp,
    d.laengedeckel,
    d.breitedeckel,
    d.abdeckungsklasse,
    d.materialabdeckung,
    d.schmutzfaenger, a.knoten_strang, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage,
    p.punktattributabwasser, a.sanierung_artmassnahme,
    p.p_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     RIGHT JOIN isybau.iden_date_stam_abwaanla_knote_bauwe_behan_anlag_anlag_deckel d ON a.ogr_pkid::text = d.parent_ogr_pkid::text -- Behandlungsanlage
     LEFT JOIN qgisybau.v_punktgeometrien p ON a.ogr_pkid::text = p.parent_ogr_pkid::text
  WHERE a.objektart = 2 
    AND a.knoten_knotentyp = 2 
    and a.geometrie_geoobjekttyp::text = 'P'::text 
    AND (p.punktattributabwasser::text = ANY (ARRAY['SBD'::character varying::text, 'DMP'::character varying::text]));

COMMENT ON VIEW qgisybau.v_deckel IS 'Deckel/Abdeckung: alle Arten von Deckeln und Einstiegs-Abdeckungen. Kein Objekt im ISYBAU Modell aber hilfreich für Kartendarstellung und notwendig zur Vermeidung von Multipart-/GeometryCollection-Objekten. Schachtabdeckung 1:1, Abdeckung von Versickerungsanlagen 1:1, Für die Bauwerkstypen Pumpwerk, Becken, Behandlungsanlage und Zisterne können jeweils 1:n Deckel dokumentiert sein.';



/*
KANTE
Abwassertechnische Anlagen gem. Arbeitshilfen Abwasser (http://www.arbeitshilfen-abwasser.de/html/ISYBAU_Austauschformate_Abwasser.14.08.html)
Haltung (H), Leitung (L), Rinne (RI), Gerinne (GE)
*/

-- Erstellung der Views in separatem Schema zum Schutz bei GMLAS Import -overwrite
--CREATE SCHEMA qgisybau;

-- H Haltung
CREATE OR REPLACE VIEW qgisybau.v_kante_haltung AS 
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.kante_kantentyp, a.kante_knotenzulauf, a.kante_knotenzulauftyp, a.kante_knotenablauf, a.kante_knotenablauftyp, a.kante_sohlhoehezulauf, a.kante_sohlhoeheablauf, a.kante_strang, a.kante_laenge, a.kante_material, a.kante_profil_sonderprofilvorhanden, a.kante_profil_profilart, a.kante_profil_profilid, a.kante_profil_profilbreite, a.kante_profil_profilhoehe, a.kante_haltung_haltungsfunktion, a.kante_haltung_dmplaenge, a.kante_haltung_rohrlaenge, a.kante_haltung_innenschutz, a.kante_haltung_auskleidung, a.kante_haltung_materialauskleidung, a.kante_haltung_nenndruck, a.kante_haltung_druckverfahren, a.kante_haltung_anschlussdaten_objektbezeichnung, a.kante_haltung_anschlussdaten_kantentyp, a.kante_haltung_anschlussdaten_entfernung, a.kante_haltung_anschlussdaten_anschlussart, a.kante_haltung_anschlussdaten_fixierung, a.kante_haltung_anschlussdaten_kommentar, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage, a.sanierung_artmassnahme,
    l.l_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     JOIN qgisybau.v_liniengeometrien l ON a.ogr_pkid::text = l.parent_ogr_pkid::text
  WHERE a.objektart = 1 -- G100 1=Kante
    AND a.kante_kantentyp = 0; -- G200 0=Haltung

-- L Leitung
CREATE OR REPLACE VIEW qgisybau.v_kante_leitung AS 
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.kante_kantentyp, a.kante_knotenzulauf, a.kante_knotenzulauftyp, a.kante_knotenablauf, a.kante_knotenablauftyp, a.kante_sohlhoehezulauf, a.kante_sohlhoeheablauf, a.kante_strang, a.kante_laenge, a.kante_material, a.kante_profil_sonderprofilvorhanden, a.kante_profil_profilart, a.kante_profil_profilid, a.kante_profil_profilbreite, a.kante_profil_profilhoehe, a.kante_leitung_leitungsfunktion, a.kante_leitung_innenschutz, a.kante_leitung_auskleidung, a.kante_leitung_materialauskleidung, a.kante_leitung_nenndruck, a.kante_leitung_druckverfahren, a.kante_leitung_anschlussdaten_objektbezeichnung, a.kante_leitung_anschlussdaten_kantentyp, a.kante_leitung_anschlussdaten_entfernung, a.kante_leitung_anschlussdaten_anschlussart, a.kante_leitung_anschlussdaten_fixierung, a.kante_leitung_anschlussdaten_kommentar, a.kante_rinne_rinnenfunktion, a.kante_gerinne_gerinnefunktion, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage, a.sanierung_artmassnahme,
    l.l_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     JOIN qgisybau.v_liniengeometrien l ON a.ogr_pkid::text = l.parent_ogr_pkid::text
  WHERE a.objektart = 1 -- G100 1=Kante
    AND a.kante_kantentyp = 1; -- G200 1=Leitung

-- RI Rinne und GE Gerinne
CREATE OR REPLACE VIEW qgisybau.v_kante_rinnen AS 
 SELECT a.ogc_fid, a.ogr_pkid, a.parent_ogr_pkid, a.objektbezeichnung, a.objektart, a.alteobjektbezeichnung, a.lisa_guid, a.reihenfolgeid, a.status, a.baujahr, a.entwaesserungsart, a.kommentar, a.kante_kantentyp, a.kante_knotenzulauf, a.kante_knotenzulauftyp, a.kante_knotenablauf, a.kante_knotenablauftyp, a.kante_sohlhoehezulauf, a.kante_sohlhoeheablauf, a.kante_strang, a.kante_laenge, a.kante_material, a.kante_profil_sonderprofilvorhanden, a.kante_profil_profilart, a.kante_profil_profilid, a.kante_profil_profilbreite, a.kante_profil_profilhoehe, a.kante_rinne_rinnenfunktion, a.kante_gerinne_gerinnefunktion, a.lage_strassenschluessel, a.lage_strassenname, a.lage_ortsteilschluessel, a.lage_ortsteilname, a.lage_lageoberflaeche, a.lage_kommentarlage, a.lage_ueberschwemmungsgebiet, a.umweltparameter_abwasserart, a.umweltparameter_abwasserartwgs, a.umweltparameter_gwabstand, a.umweltparameter_wasserschutzzone, a.umweltparameter_bodenart, a.geometrie_vorlaeufigebezeichnung, a.geometrie_geoobjektart, a.geometrie_geoobjekttyp, a.geometrie_lagegenauigkeitsklasse, a.geometrie_hoehengenauigkeitsklasse, a.geometrie_datenherkunft, a.geometrie_kommentar, a.geometrie_crslage, a.sanierung_artmassnahme,
    l.l_geom_2d AS geom
   FROM isybau.identifikati_datenkollekti_stammdatenkol_abwassertechnanlage a
     JOIN qgisybau.v_liniengeometrien l ON a.ogr_pkid::text = l.parent_ogr_pkid::text
  WHERE a.objektart = 1 -- G100 1=Kante
    AND (a.kante_kantentyp = ANY (ARRAY[2, 3])); -- G200 2=Rinne 3=Gerinne

  
